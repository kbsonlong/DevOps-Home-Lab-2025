apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tunnel-ingress
  namespace: humor-game
  annotations:
    # Disable SSL redirect for tunnel hosts
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: app.kbsonlong.com  # Cloudflare tunnel subdomain
      http:
        paths:
          # API routes - forward to backend
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 3001
          # Backend endpoints - forward to backend
          - path: /health
            pathType: Exact
            backend:
              service:
                name: backend
                port:
                  number: 3001
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: backend
                port:
                  number: 3001
          - path: /debug
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 3001
          # Everything else - serve from frontend
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80

---
# Grafana Ingress for monitoring
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-tunnel-ingress
  namespace: monitoring
  annotations:
    # Disable SSL redirect for tunnel hosts
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: grafana.kbsonlong.com  # Monitoring subdomain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000

---
# Prometheus Ingress for monitoring
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-tunnel-ingress
  namespace: monitoring
  annotations:
    # Disable SSL redirect for tunnel hosts
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: prometheus.kbsonlong.com  # Monitoring subdomain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090

---
# ArgoCD Ingress for GitOps
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-tunnel-ingress
  namespace: argocd
  annotations:
    # Disable SSL redirect for tunnel hosts
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: argocd.kbsonlong.com  # ArgoCD subdomain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 80
